name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: write

env:
  IMAGE_REGISTRY: inikolov98
  IMAGE_NAME: my-jira-automation
  IMAGE_TAG: ${{ github.sha }}

jobs:
  quality:
    name: Secrets, Lint, Test, SAST, SonarCloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@v2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest

      - name: Lint Python code
        run: |
          flake8 app/ --count --max-line-length=120 --statistics || true

      - name: Run Tests
        run: |
          pytest app/ || true

      - name: SonarCloud Scan
        if: ${{ env.SONAR_TOKEN != '' }}
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  build_scan_push_gitops:
    name: Build, Trivy, Push, GitOps Update
    runs-on: ubuntu-latest
    needs: quality
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_REGISTRY/$IMAGE_NAME:$IMAGE_TAG .

      - name: Trivy scan (HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: table
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: "1"

      - name: Push Docker image
        run: |
          docker push $IMAGE_REGISTRY/$IMAGE_NAME:$IMAGE_TAG

      - name: Update GitOps manifests (kustomize image tag)
        run: |
          sudo apt-get update
          sudo apt-get install -y git

          curl -sSL https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.5.0/kustomize_v5.5.0_linux_amd64.tar.gz | tar -xz
          sudo mv kustomize /usr/local/bin/kustomize

          cd ops/k8s
          kustomize edit set image \
            $IMAGE_REGISTRY/$IMAGE_NAME=$IMAGE_REGISTRY/$IMAGE_NAME:$IMAGE_TAG

          cd ../../
          sed -i "s/value: \"dev\"/value: \"${IMAGE_TAG}\"/g" ops/k8s/deployment.yaml || true

      - name: Commit and push GitOps change
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add ops/k8s/kustomization.yaml ops/k8s/deployment.yaml
          git commit -m "gitops: deploy image $IMAGE_REGISTRY/$IMAGE_NAME:$IMAGE_TAG" || echo "No changes to commit"
          git push
